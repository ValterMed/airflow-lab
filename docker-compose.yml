

# ========================================================================================
# üê≥ DOCKER COMPOSE - ECOMMERCE ANALYTICS WITH KAFKA + MONGODB
# ========================================================================================
#
# ARQUITECTURA:
# - Kafka ecosystem (Zookeeper + Kafka + UI) para streaming de eventos
# - MongoDB para persistencia de eventos de e-commerce
# - Consumer: Persiste eventos de Kafka a MongoDB
# - Dashboard: Streamlit para visualizaci√≥n y an√°lisis
# - Mongo Express para administraci√≥n de MongoDB
#
# FLUJO DE DATOS:
# 1. Producer (manual) ‚Üí Kafka topic: ecommerce.events
# 2. Consumer ‚Üí Lee de Kafka y escribe en MongoDB
# 3. Dashboard ‚Üí Lee de MongoDB y visualiza m√©tricas
#
# NETWORKING: Todos los servicios en la misma red Docker para comunicaci√≥n interna
# ========================================================================================

services:
  # ==================================================================================
  # üõí ECOMMERCE CONSUMER - KAFKA ‚Üí MONGODB
  # ==================================================================================
  # PROP√ìSITO: Consume eventos de e-commerce desde Kafka y los persiste en MongoDB
  ecommerce-consumer:
    build:
      context: .
      dockerfile: src/api-producer/Dockerfile.worker
    command: ["python", "consumers/ecommerce_consumer.py"]
    environment:
      - KAFKA_BROKER=kafka:29092
      - KAFKA_TOPIC=ecommerce.events
      - KAFKA_GROUP_ID=ecommerce-mongo-consumer
      - MONGODB_URI=mongodb://admin:mongopass@mongodb:27017/
      - MONGODB_DB=kafka_events_db
    depends_on:
      kafka:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - kafka-mongo-network
    restart: unless-stopped

  # ==================================================================================
  # üìä ECOMMERCE DASHBOARD - STREAMLIT VISUALIZATION
  # ==================================================================================
  # PROP√ìSITO: Dashboard web interactivo para an√°lisis de eventos de e-commerce
  # ACCESO: http://localhost:8501
  ecommerce-dashboard:
    build:
      context: ./src/dashboard
      dockerfile: Dockerfile
    ports:
      - "8501:8501"
    environment:
      - MONGODB_URI=mongodb://admin:mongopass@mongodb:27017/
      - MONGODB_DB=kafka_events_db
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - kafka-mongo-network
    restart: unless-stopped
  # ==================================================================================
  # üêò ZOOKEEPER - COORDINACI√ìN DE KAFKA
  # ==================================================================================
  # PROP√ìSITO: Gestiona la metadata y coordinaci√≥n del cluster de Kafka
  # DEPENDENCIAS: Ninguna (servicio fundamental)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    container_name: kafka-lab-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: WARN
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      - kafka-mongo-network
    healthcheck:
      test: ["CMD", "bash", "-c", "echo ruok | nc localhost 2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================================================================================
  # üì® KAFKA BROKER - STREAMING PLATFORM
  # ==================================================================================
  # PROP√ìSITO: Message broker para streaming de eventos en tiempo real
  # DEPENDENCIAS: Zookeeper (para coordinaci√≥n)
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    container_name: kafka-lab-broker
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9101:9101"
    environment:
      # Configuraci√≥n b√°sica de Kafka
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      
      # Listeners: C√≥mo Kafka escucha conexiones
      # PLAINTEXT: Para clientes internos (Docker network)
      # PLAINTEXT_HOST: Para clientes externos (localhost)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      
      # Configuraci√≥n de replicaci√≥n y offsets
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      
      # JMX para monitoreo
      KAFKA_JMX_PORT: 9101
      KAFKA_JMX_HOSTNAME: localhost
      
      # Configuraci√≥n de performance
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
      
      # Logs menos verbosos
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
      KAFKA_TOOLS_LOG4J_LOGLEVEL: ERROR
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - kafka-mongo-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  # ==================================================================================
  # üéõÔ∏è KAFKA UI - WEB INTERFACE PARA KAFKA
  # ==================================================================================
  # PROP√ìSITO: Interfaz gr√°fica para visualizar topics, mensajes, consumer groups
  # ACCESO: http://localhost:8080
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-lab-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      DYNAMIC_CONFIG_ENABLED: 'true'
      LOGGING_LEVEL_ROOT: WARN
    networks:
      - kafka-mongo-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================================================================================
  # üóÑÔ∏è MONGODB - NOSQL DOCUMENT DATABASE
  # ==================================================================================
  # PROP√ìSITO: Base de datos NoSQL para almacenar eventos de Kafka como documentos
  # FEATURES CLAVE:
  # - Schema-less: Flexibilidad para datos semi-estructurados
  # - Horizontal scaling: Sharding para big data
  # - Rich queries: Aggregation pipeline, geospatial, text search
  # - Indexes: Performance optimization
  mongodb:
    image: mongo:7.0
    hostname: mongodb
    container_name: kafka-lab-mongodb
    ports:
      - "27017:27017"
    environment:
      # Credenciales de admin
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongopass
      
      # Base de datos inicial para el lab
      MONGO_INITDB_DATABASE: kafka_events_db
    volumes:
      # Persistencia de datos en volumen Docker
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      
      # Script de inicializaci√≥n (crear colecciones, √≠ndices, usuarios)
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - kafka-mongo-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: ["mongod", "--auth"]

  # ==================================================================================
  # üåê MONGO EXPRESS - WEB UI PARA MONGODB
  # ==================================================================================
  # PROP√ìSITO: Interfaz web para explorar y gestionar MongoDB visualmente
  # ACCESO: http://localhost:8081
  # ESTUDIANTES: √ösenlo para:
  # - Ver colecciones y documentos
  # - Ejecutar queries manualmente
  # - Verificar que los consumers est√°n insertando datos
  # - Explorar la estructura de documentos JSON
  mongo-express:
    image: mongo-express:1.0.0
    container_name: kafka-lab-mongo-express
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      # Conexi√≥n a MongoDB
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: mongopass
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      
      # Credenciales de acceso a Mongo Express
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: mongopass
      
      # Configuraci√≥n de UI
      ME_CONFIG_SITE_BASEURL: /
      ME_CONFIG_SITE_COOKIESECRET: mongoexpress
      ME_CONFIG_SITE_SESSIONSECRET: mongoexpress
    networks:
      - kafka-mongo-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3

# ====================================================================================
# üì¶ VOLUMES - PERSISTENCIA DE DATOS
# ====================================================================================
# CONCEPTO: Los vol√∫menes Docker persisten datos entre reinicios de contenedores
# SIN VOL√öMENES: Si borras un contenedor, pierdes todos los datos
# CON VOL√öMENES: Los datos sobreviven incluso si destruyes y recreas contenedores
volumes:
  zookeeper-data:
    name: kafka-lab-zookeeper-data
  zookeeper-logs:
    name: kafka-lab-zookeeper-logs
  kafka-data:
    name: kafka-lab-kafka-data
  mongodb-data:
    name: kafka-lab-mongodb-data
  mongodb-config:
    name: kafka-lab-mongodb-config

# ====================================================================================
# üåê NETWORKS - RED DOCKER
# ====================================================================================
# CONCEPTO: Red privada para que los contenedores se comuniquen entre s√≠
# BENEFICIOS:
# - Aislamiento: No interfiere con otros proyectos Docker
# - Service discovery: Los contenedores se encuentran por nombre (kafka, mongodb)
# - Performance: Comunicaci√≥n interna m√°s r√°pida
networks:
  kafka-mongo-network:
    name: kafka-mongo-network
    driver: bridge

# ====================================================================================
# üìù NOTAS PARA ESTUDIANTES
# ====================================================================================
#
# üöÄ COMANDOS √öTILES:
#
# Iniciar todos los servicios:
#   docker-compose up -d
#
# Ver logs de un servicio espec√≠fico:
#   docker-compose logs -f kafka
#   docker-compose logs -f mongodb
#
# Ver estado de servicios:
#   docker-compose ps
#
# Detener todos los servicios:
#   docker-compose down
#
# Detener Y eliminar vol√∫menes (¬°cuidado! borra datos):
#   docker-compose down -v
#
# Reiniciar un servicio espec√≠fico:
#   docker-compose restart kafka
#
# Acceder al shell de MongoDB:
#   docker exec -it kafka-lab-mongodb mongosh -u admin -p mongopass
#
# Acceder al shell de Kafka:
#   docker exec -it kafka-lab-broker bash
#
# ====================================================================================
# üîç VERIFICACI√ìN DE SERVICIOS:
# ====================================================================================
#
# 1. Kafka UI: http://localhost:8080
#    ‚úÖ Deber√≠as ver el cluster "local"
#    ‚úÖ Topics: ecommerce.events
#
# 2. E-commerce Dashboard: http://localhost:8501
#    ‚úÖ Visualizaci√≥n de m√©tricas de e-commerce
#    ‚úÖ An√°lisis de segmentaci√≥n de usuarios
#
# 3. Mongo Express: http://localhost:8081 (admin/mongopass)
#    ‚úÖ Base de datos: kafka_events_db
#    ‚úÖ Colecci√≥n: ecommerce
#
# 4. MongoDB (comando en terminal):
#    docker exec -it kafka-lab-mongodb mongosh -u admin -p mongopass
#    > use kafka_events_db
#    > db.ecommerce.countDocuments()
#    ‚úÖ Deber√≠a mostrar el n√∫mero de eventos insertados
#
# ====================================================================================
# üéØ ARQUITECTURA DE PUERTOS:
# ====================================================================================
#
# Puerto  | Servicio           | Prop√≥sito
# --------|--------------------|-------------------------------------------------
# 2181    | Zookeeper          | Coordinaci√≥n de Kafka
# 9092    | Kafka              | Conexi√≥n de producers/consumers
# 8080    | Kafka UI           | Interfaz web de Kafka
# 8501    | Dashboard          | Dashboard de an√°lisis de e-commerce (Streamlit)
# 27017   | MongoDB            | Conexi√≥n de aplicaciones Python (pymongo)
# 8081    | Mongo Express      | Interfaz web de MongoDB
#
# ====================================================================================
 

